# Generated by surreal-loadtest
# Source: kafka
# Containers: 2

version: '3.8'
services:
  kafka:
    image: apache/kafka:latest
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    environment:
    - KAFKA_NODE_ID=1
    - KAFKA_PROCESS_ROLES=broker,controller
    - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
    - KAFKA_LISTENERS=PLAINTEXT://kafka:19092,PLAINTEXT_HOST://kafka:9092,CONTROLLER://kafka:9093
    - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:19092,PLAINTEXT_HOST://kafka:9092
    - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
    - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
    - KAFKA_NUM_PARTITIONS=8
    - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
    - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
    - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
    volumes:
    - kafka_data:/var/lib/kafka/data
    healthcheck:
      test:
      - CMD-SHELL
      - /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server kafka:9092 || exit 1
      interval: 10s
      timeout: 10s
      retries: 10
  surrealdb:
    image: surrealdb/surrealdb:latest
    command: start --log info --user root --pass root --bind 0.0.0.0:8000 memory
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    healthcheck:
      test:
      - CMD
      - /surreal
      - is-ready
      - --endpoint
      - http://localhost:8000
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
  populate-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate kafka --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42 --kafka-brokers 'kafka:9092' --batch-size 500
    environment:
    - CONTAINER_ID=populate-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      kafka:
        condition: service_healthy
      aggregator:
        condition: service_started
  populate-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate kafka --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43 --kafka-brokers 'kafka:9092' --batch-size 500
    environment:
    - CONTAINER_ID=populate-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      kafka:
        condition: service_healthy
      aggregator:
        condition: service_started
  sync-users:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from kafka --proto-path '/proto/users.proto' --brokers 'kafka:9092' --group-id 'loadtest-sync-users' --topic 'users' --message-type 'Users' --buffer-size 1000 --session-timeout-ms 30000 --kafka-batch-size 100 --timeout '1m' --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    - ./config/proto:/proto:ro
    networks:
    - loadtest-network
    depends_on:
      populate-1:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      kafka:
        condition: service_healthy
  sync-orders:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from kafka --proto-path '/proto/orders.proto' --brokers 'kafka:9092' --group-id 'loadtest-sync-orders' --topic 'orders' --message-type 'Orders' --buffer-size 1000 --session-timeout-ms 30000 --kafka-batch-size 100 --timeout '1m' --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    - ./config/proto:/proto:ro
    networks:
    - loadtest-network
    depends_on:
      populate-1:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      kafka:
        condition: service_healthy
  sync-products:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from kafka --proto-path '/proto/products.proto' --brokers 'kafka:9092' --group-id 'loadtest-sync-products' --topic 'products' --message-type 'Products' --buffer-size 1000 --session-timeout-ms 30000 --kafka-batch-size 100 --timeout '1m' --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    - ./config/proto:/proto:ro
    networks:
    - loadtest-network
    depends_on:
      populate-2:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      kafka:
        condition: service_healthy
  sync-order_items:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from kafka --proto-path '/proto/order_items.proto' --brokers 'kafka:9092' --group-id 'loadtest-sync-order_items' --topic 'order_items' --message-type 'OrderItems' --buffer-size 1000 --session-timeout-ms 30000 --kafka-batch-size 100 --timeout '1m' --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    - ./config/proto:/proto:ro
    networks:
    - loadtest-network
    depends_on:
      populate-2:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      kafka:
        condition: service_healthy
  verify-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42
    environment:
    - CONTAINER_ID=verify-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync-users:
        condition: service_completed_successfully
      sync-orders:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  verify-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43
    environment:
    - CONTAINER_ID=verify-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync-products:
        condition: service_completed_successfully
      sync-order_items:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  aggregator:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest aggregate-server --listen 0.0.0.0:9090 --expected-containers 4 --timeout 30m --output-format table
    environment:
    - RUST_LOG=info
    ports:
    - 9090:9090
    networks:
    - loadtest-network
networks:
  loadtest-network:
    driver: bridge
volumes:
  loadtest-results: {}
  kafka_data: {}
