# Generated by surreal-loadtest
# Source: mysql
# Containers: 2

version: '3.8'
services:
  mysql:
    image: mysql:8.0
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    environment:
    - MYSQL_ROOT_PASSWORD=root
    - MYSQL_DATABASE=loadtest
    command:
    - --default-authentication-plugin=mysql_native_password
    - --max_connections=200
    - --innodb_buffer_pool_size=1G
    - --innodb_log_file_size=256M
    - --innodb_flush_log_at_trx_commit=2
    - --sync_binlog=0
    - --skip-log-bin
    volumes:
    - mysql_data:/var/lib/mysql
    healthcheck:
      test:
      - CMD
      - mysqladmin
      - ping
      - -h
      - localhost
      interval: 5s
      timeout: 3s
      retries: 10
  surrealdb:
    image: surrealdb/surrealdb:latest
    command: start --log info --user root --pass root --bind 0.0.0.0:8000 memory
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    healthcheck:
      test:
      - CMD
      - /surreal
      - is-ready
      - --endpoint
      - http://localhost:8000
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
  populate-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate mysql --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42 --mysql-connection-string 'mysql://root:root@mysql:3306/loadtest' --batch-size 500
    environment:
    - CONTAINER_ID=populate-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      mysql:
        condition: service_healthy
      aggregator:
        condition: service_started
  populate-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate mysql --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43 --mysql-connection-string 'mysql://root:root@mysql:3306/loadtest' --batch-size 500
    environment:
    - CONTAINER_ID=populate-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      mysql:
        condition: service_healthy
      aggregator:
        condition: service_started
  sync:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from mysql full --connection-string 'mysql://root:root@mysql:3306/loadtest' --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      populate-1:
        condition: service_completed_successfully
      populate-2:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      mysql:
        condition: service_healthy
  verify-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42
    environment:
    - CONTAINER_ID=verify-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  verify-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43
    environment:
    - CONTAINER_ID=verify-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  aggregator:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest aggregate-server --listen 0.0.0.0:9090 --expected-containers 4 --timeout 30m --output-format table
    environment:
    - RUST_LOG=info
    ports:
    - 9090:9090
    networks:
    - loadtest-network
networks:
  loadtest-network:
    driver: bridge
volumes:
  loadtest-results: {}
  mysql_data: {}
