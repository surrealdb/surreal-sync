# Generated by surreal-loadtest
# Source: neo4j
# Containers: 2

version: '3.8'
services:
  neo4j:
    image: neo4j:5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    environment:
    - NEO4J_AUTH=neo4j/password
    - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    - NEO4J_dbms_memory_heap_initial__size=409m
    - NEO4J_dbms_memory_heap_max__size=409m
    - NEO4J_dbms_memory_pagecache_size=307m
    - NEO4J_PLUGINS=["apoc"]
    - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    - NEO4J_dbms_logs_query_enabled=OFF
    volumes:
    - neo4j_data:/data
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:7474
      interval: 10s
      timeout: 5s
      retries: 10
  surrealdb:
    image: surrealdb/surrealdb:latest
    command: start --log info --user root --pass root --bind 0.0.0.0:8000 memory
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
    networks:
    - loadtest-network
    healthcheck:
      test:
      - CMD
      - /surreal
      - is-ready
      - --endpoint
      - http://localhost:8000
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
  populate-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate neo4j --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42 --neo4j-connection-string 'bolt://neo4j:password@neo4j:7687' --neo4j-username neo4j --neo4j-password password --batch-size 500
    environment:
    - CONTAINER_ID=populate-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      neo4j:
        condition: service_healthy
      aggregator:
        condition: service_started
  populate-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest populate neo4j --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43 --neo4j-connection-string 'bolt://neo4j:password@neo4j:7687' --neo4j-username neo4j --neo4j-password password --batch-size 500
    environment:
    - CONTAINER_ID=populate-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    tmpfs:
    - /data:size=256m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    networks:
    - loadtest-network
    depends_on:
      neo4j:
        condition: service_healthy
      aggregator:
        condition: service_started
  sync:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: from neo4j full --connection-string 'bolt://neo4j:7687' --username neo4j --password password --to-namespace loadtest --to-database test --surreal-endpoint 'http://surrealdb:8000' --surreal-username root --surreal-password root --schema-file /config/schema.yaml
    environment:
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      populate-1:
        condition: service_completed_successfully
      populate-2:
        condition: service_completed_successfully
      surrealdb:
        condition: service_healthy
      neo4j:
        condition: service_healthy
  verify-1:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables users,orders --row-count 1000 --seed 42
    environment:
    - CONTAINER_ID=verify-1
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  verify-2:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest verify --surreal-endpoint 'http://surrealdb:8000' --surreal-namespace loadtest --surreal-database test --surreal-username root --surreal-password root --schema /config/schema.yaml --tables products,order_items --row-count 1000 --seed 43
    environment:
    - CONTAINER_ID=verify-2
    - RUST_LOG=info
    volumes:
    - ./config:/config:ro
    networks:
    - loadtest-network
    depends_on:
      sync:
        condition: service_completed_successfully
      aggregator:
        condition: service_started
  aggregator:
    image: surreal-sync:latest
    labels:
      com.surreal-loadtest: 'true'
    command: loadtest aggregate-server --listen 0.0.0.0:9090 --expected-containers 4 --timeout 30m --output-format table
    environment:
    - RUST_LOG=info
    ports:
    - 9090:9090
    networks:
    - loadtest-network
networks:
  loadtest-network:
    driver: bridge
volumes:
  loadtest-results: {}
  neo4j_data: {}
